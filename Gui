-- Load Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

if not Rayfield then
    warn("Failed to load Rayfield")
    return
end

-- Window (KEY SYSTEM INCLUDED)
local Window = Rayfield:CreateWindow({
    Name = "Vision Hub",
    LoadingTitle = "Vision Script",
    LoadingSubtitle = "by Vision",
    ConfigurationSaving = {
       Enabled = false,
       FileName = "Vision Script Hub"
    },
    Discord = {
       Enabled = true,
       Invite = "GYH92be25Z",
       RememberJoins = true
    },
    KeySystem = true,
    KeySettings = {
       Title = "Vision Script Hub | Key",
       Subtitle = "Link In Discord Server",
       Note = "Join Server From Misc Tab",
       FileName = "BladeBallKey",
       SaveKey = false,
       GrabKeyFromSite = true,
       Key = {"https://pastebin.com/raw/QZYyHa0H"}
    }
})

-- Tab
local MainTab = Window:CreateTab("Main", nil)
MainTab:CreateSection("Useful")

---------------------------------------------------------------------
-- AUTO METER RELEASE (TOGGLE CONTROLLED)
---------------------------------------------------------------------

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local AutoMeterEnabled = false
local meterConnection = nil
local customMeterOffset = -1.27 -- default value

local function getCharacter()
    return workspace:WaitForChild("Characters"):WaitForChild(LocalPlayer.Name)
end

local function fireShoot()
    local Character = getCharacter()
    -- Check if new park remote exists
    local parkRemote = ReplicatedStorage:FindFirstChild("RemoteEvent")
    if parkRemote then
        -- Fire the new park remote
        local args = {
            [1] = {
                [1] = {
                    [1] = "5",
                    [2] = { ["Shoot"] = false }
                }
            }
        }
        parkRemote:FireServer(unpack(args))
    else
        -- Fire the old remote
        ReplicatedStorage.Aero.AeroRemoteServices.InputService.Shoot:FireServer({Shoot = false})
    end
end

local function connectMeter()
    if meterConnection then
        meterConnection:Disconnect()
        meterConnection = nil
    end

    local Character = getCharacter()

    meterConnection = Character:GetAttributeChangedSignal("meterOffset"):Connect(function()
        if not AutoMeterEnabled then return end

        local meterOffset = Character:GetAttribute("meterOffset")

        -- VerticalMeter
        if Character.HumanoidRootPart:FindFirstChild("VerticalMeter") and Character.HumanoidRootPart.VerticalMeter.Enabled then
            if meterOffset.Y <= customMeterOffset then
                fireShoot()
            end

        -- BatMeter
        elseif Character.HumanoidRootPart:FindFirstChild("BatMeter") and Character.HumanoidRootPart.BatMeter.Enabled then
            if meterOffset.Y <= customMeterOffset then
                fireShoot()
            end

        -- RocketMeter
        elseif Character.HumanoidRootPart:FindFirstChild("RocketMeter") and Character.HumanoidRootPart.RocketMeter.Enabled then
            if meterOffset.Y <= customMeterOffset then
                fireShoot()
            end

        -- HoopMeter (Park mode)
        elseif Character.Head:FindFirstChild("HoopMeter") and Character.Head.HoopMeter.Enabled then
            if meterOffset.Y >= -customMeterOffset then -- invert if needed for Park
                fireShoot()
            end

        -- RobloxMeter
        elseif Character.Head:FindFirstChild("RobloxMeter") and Character.Head.RobloxMeter.Enabled then
            if meterOffset.X >= -customMeterOffset then -- invert if needed for Roblox
                fireShoot()
            end

        -- Default fallback
        else
            if meterOffset.Y <= customMeterOffset then
                fireShoot()
            end
        end
    end)
end

-- Reconnect on respawn
LocalPlayer.CharacterAdded:Connect(function()
    if AutoMeterEnabled then
        task.wait(1)
        connectMeter()
    end
end)

-- Toggle
MainTab:CreateToggle({
    Name = "Auto Perfect",
    CurrentValue = false,
    Flag = "AutoMeterRelease_Toggle",
    Callback = function(Value)
        AutoMeterEnabled = Value
        if Value then
            connectMeter()
        else
            if meterConnection then
                meterConnection:Disconnect()
                meterConnection = nil
            end
        end
    end,
})

-- Slider for adjusting all meter offsets
MainTab:CreateSlider({
    Name = "Meter Offset",
    Range = {-1.40, -0.80},
    Increment = 0.01,
    Suffix = "",
    CurrentValue = customMeterOffset,
    Flag = "MeterOffsetSlider",
    Callback = function(Value)
        customMeterOffset = Value
    end,
})

-- Notify
Rayfield:Notify({
    Title = "Vision Hub",
    Content = "Vision Hub Loaded",
    Duration = 4,
})
